# 业务规则与状态分析报告

**分析时间**：2026-01-14  
**分析角色**：业务 Agent  
**项目状态**：半成品（开发中）  
**分析目的**：梳理业务规则、识别TODO与潜在歧义、提出补充规则建议

---

## 一、业务规则与状态描述

### 1.1 销售订单流程

#### 1.1.1 订单状态流转规则

**状态定义**：
- `pending`：待审批（销售员创建后）
- `approved`：已审批（销售经理审批后，但此状态实际不会停留，直接进入下一状态）
- `ceo_pending`：待总经理审批（销售经理审批后）
- `ceo_approved`：总经理已审批（总经理审批后，但此状态实际不会停留，直接进入下一状态）
- `rejected`：已退回（销售经理或总经理退回）
- `in_production`：生产中（总经理审批后，库存不足，创建了生产任务）
- `ready_to_ship`：待发货（总经理审批后，库存充足，创建了发货通知单）
- `shipped`：已发货（物流确认发货后）
- `completed`：已完成（所有发货单都送达后）
- `cancelled`：已取消（销售员在待审批状态下取消）
- `terminated`：已终结（总经理终结订单及关联流程）

**状态流转规则**：
1. **创建订单**：销售员创建 → `pending`
2. **销售经理审批**：
   - 审批通过 → `ceo_pending`（跳过`approved`状态）
   - 审批退回 → `rejected`
3. **总经理审批**：
   - 审批通过 → 自动触发库存研判，根据结果进入 `in_production` 或 `ready_to_ship`
   - 审批退回 → `rejected`
4. **库存研判后**：
   - 库存充足 → `ready_to_ship`（创建发货通知单）
   - 库存不足 → `in_production`（创建生产任务）
5. **生产完成后**：如果所有生产任务完成，且库存充足 → `ready_to_ship`
6. **发货后**：`shipped`
7. **所有发货单送达后**：`completed`
8. **终结**：总经理可在多个状态下终结订单，会回滚库存

**潜在歧义**：
- ⚠️ `approved`状态在代码中定义但实际不会停留，可能造成理解困惑
- ⚠️ `ceo_approved`状态在代码中定义但实际不会停留，可能造成理解困惑
- ⚠️ 订单终结时，如果已发货，需要重新入库，但规则未明确说明是否创建新批次

#### 1.1.2 订单审批规则

**销售经理审批**：
- 权限：`sales_mgr` 或 `ceo` 角色
- 可审批状态：仅 `pending`
- 审批后：进入 `ceo_pending` 状态

**总经理审批**：
- 权限：`ceo` 角色
- 可审批状态：仅 `ceo_pending`
- 审批前：系统会进行库存预判（不实际创建任务）
- 审批后：自动触发 `check_inventory_and_create_tasks()` 函数

**退回规则**：
- 销售经理可退回 `pending` 状态的订单
- 总经理可退回 `ceo_pending` 状态的订单
- 退回后状态变为 `rejected`，销售员可修改后重新提交

**潜在歧义**：
- ⚠️ 退回后的订单修改规则未明确：是否保留原订单号？是否保留审批历史？
- ⚠️ 退回后重新提交是否需要重新走完整审批流程？

#### 1.1.3 库存研判规则（`check_inventory_and_create_tasks`）

**研判逻辑**：
1. 遍历订单所有明细项
2. 对每个明细项：
   - 计算已分配的批次数量总和（从`SalesOrderItemBatch`）
   - 计算缺口 = 订单数量 - 批次分配总和
   - 如果缺口 > 0：
     - 检查原材料是否充足（根据BOM计算）
     - 创建生产任务，状态为 `pending`（原材料充足）或 `material_insufficient`（原材料不足）
3. 如果所有明细项批次分配都充足：
   - 创建发货通知单（`ShippingNotice`）
   - 订单状态 → `ready_to_ship`
4. 如果存在缺口：
   - 订单状态 → `in_production`

**批次分配规则**：
- 批次分配在总经理审批前进行（在`ceo_approve`视图的GET请求中）
- 使用FIFO原则分配批次
- 批次分配记录在`SalesOrderItemBatch`中，但不立即扣减库存
- 库存扣减在发货时进行

**潜在歧义**：
- ⚠️ 批次分配后，如果其他订单也分配了相同批次，可能导致库存不足
- ⚠️ 批次分配是否应该锁定库存？当前规则是"不锁定，发货时扣减"
- ⚠️ 如果批次分配总和小于订单数量，创建生产任务；但如果批次分配总和大于订单数量，如何处理？规则未明确

#### 1.1.4 订单终结规则（`terminate_order_chain`）

**终结条件**：
- 权限：`ceo` 角色
- 可终结状态：`in_production`、`ready_to_ship`、`shipped`

**终结操作**：
1. 如果订单状态为 `shipped`：
   - 查找所有已发货的发货单
   - 对每个订单项，重新入库（增加库存）
   - 记录库存变动（类型为`adjustment`）
2. 终结所有关联的生产任务（状态 → `terminated`）
3. 终结所有关联的领料单（状态 → `terminated`）
4. 订单状态 → `terminated`

**潜在歧义**：
- ⚠️ 已发货订单重新入库时，是否创建新批次？当前规则是直接增加库存数量，不创建批次
- ⚠️ 如果生产任务已完成并已入库，终结时是否需要扣减已入库的成品库存？规则未明确
- ⚠️ 如果领料单已发料（原料已扣减），终结时是否需要重新入库原料？规则未明确

---

### 1.2 生产任务流程

#### 1.2.1 生产任务状态流转规则

**状态定义**：
- `pending`：待接收（创建后，原材料充足）
- `material_insufficient`：原料不足（创建时或接收时发现原材料不足）
- `received`：已接收（此状态在代码中定义但实际不会停留）
- `material_preparing`：备料中（领料单审批后）
- `in_production`：生产中（任务接收后直接进入此状态，或领料单审批后）
- `qc_checking`：质检中（生产完成后）
- `completed`：已完成（入库后，完成数量 >= 需求数量）
- `cancelled`：已取消
- `terminated`：已终结

**状态流转规则**：
1. **创建任务**：
   - 原材料充足 → `pending`
   - 原材料不足 → `material_insufficient`
2. **接收任务**：
   - 检查原材料是否充足
   - 如果不足 → `material_insufficient`
   - 如果充足 → 直接进入 `in_production`（跳过`received`和`material_preparing`状态）
   - 自动创建领料单并自动批准
   - 自动扣减原料库存（不按批次，直接扣减总数量）
3. **生产完成**：`in_production` → `qc_checking`
4. **质检完成**：质检记录创建后，状态仍为 `qc_checking`（可多次质检）
5. **入库**：创建入库单后，如果完成数量 >= 需求数量 → `completed`
6. **任务完成后**：如果是订单生产，检查订单是否可以发货

**潜在歧义**：
- ⚠️ `received`状态在代码中定义但实际不会停留，可能造成理解困惑
- ⚠️ 任务接收时自动创建领料单并自动批准，跳过了仓库管理员的审批流程，是否符合业务规则？
- ⚠️ 任务接收时扣减库存不按批次（直接扣减总数量），但领料单审批时按批次FIFO扣减，两种方式不一致
- ⚠️ 质检不合格（`unqualified`或`rework`）时，任务状态如何处理？规则未明确
- ⚠️ 如果完成数量 > 需求数量，如何处理？规则未明确

#### 1.2.2 领料单流程规则

**状态定义**：
- `pending`：待审核
- `approved`：已批准
- `issued`：已发料（此状态在代码中定义但实际不使用）
- `cancelled`：已取消
- `terminated`：已终结

**状态流转规则**：
1. **创建领料单**：
   - 任务接收时自动创建，状态为 `pending`
   - 但立即自动批准为 `approved`（跳过仓库管理员审批）
   - 立即扣减库存
2. **手动创建领料单**（如果任务状态为`material_insufficient`后原材料补足）：
   - 创建后状态为 `pending`
   - 仓库管理员审批 → `approved`
   - 审批时按批次FIFO扣减库存
3. **发料**：`issued`状态在代码中定义但实际不使用

**潜在歧义**：
- ⚠️ `issued`状态在代码中定义但实际不使用，可能造成理解困惑
- ⚠️ 任务接收时自动批准领料单，是否应该改为需要仓库管理员审批？
- ⚠️ 任务接收时扣减库存的方式（直接扣减总数量）与领料单审批时扣减库存的方式（按批次FIFO）不一致

#### 1.2.3 质检规则

**质检记录创建**：
- 权限：`qc` 或 `ceo` 角色
- 可在任务状态为 `in_production` 或 `qc_checking` 时创建
- 一个任务可以有多条质检记录

**质检结果**：
- `qualified`：合格
- `unqualified`：不合格
- `rework`：返工

**质检后处理**：
- 如果结果为 `qualified`：可以入库
- 如果结果为 `unqualified` 或 `rework`：规则未明确如何处理

**潜在歧义**：
- ⚠️ 质检不合格时，任务状态如何处理？是否需要重新生产？
- ⚠️ 返工（`rework`）的具体流程是什么？是否需要创建新的生产任务？
- ⚠️ 质检记录与入库单的关联关系：入库单可以关联质检记录，但不是必须的，规则未明确

#### 1.2.4 成品入库规则

**入库条件**：
- 权限：`warehouse` 或 `ceo` 角色
- 任务状态：`qc_checking`（理论上，但代码中未强制检查）
- 可以多次入库，直到完成数量 >= 需求数量

**入库操作**：
1. 创建入库单（`FinishedProductInbound`）
2. 创建批次（`Batch`）：
   - 批次号可以手动输入或自动生成
   - 批次日期默认为今天
   - 批次单价默认为产品基础单价
   - 过期日期可选
3. 增加成品库存（从批次汇总）
4. 记录库存变动（类型为`production_in`）
5. 更新任务完成数量
6. 如果完成数量 >= 需求数量，任务状态 → `completed`
7. 如果任务完成且是订单生产，检查订单是否可以发货

**潜在歧义**：
- ⚠️ 入库数量是否可以超过需求数量？如果超过，如何处理？
- ⚠️ 如果任务已完成（`completed`），是否还可以继续入库？规则未明确
- ⚠️ 入库时是否必须关联质检记录？当前规则是"可以关联，但不是必须的"

---

### 1.3 采购任务流程

#### 1.3.1 采购任务状态流转规则

**状态定义**：
- `pending`：待审批
- `approved`：已审批
- `purchasing`：采购中（此状态在代码中定义但实际不会停留）
- `completed`：已完成
- `cancelled`：已取消
- `terminated`：已终结

**状态流转规则**：
1. **创建任务**：`pending`
2. **审批**：`pending` → `approved`（权限：`ceo`）
3. **完成采购**：`approved` 或 `purchasing` → `completed`（权限：`warehouse` 或 `ceo`）
4. **终结**：`pending`、`approved`、`purchasing` → `terminated`（权限：`ceo`）

**潜在歧义**：
- ⚠️ `purchasing`状态在代码中定义但实际不会停留，可能造成理解困惑
- ⚠️ 采购任务完成时，是否应该先进入`purchasing`状态，然后再完成？当前规则是直接从`approved`到`completed`

#### 1.3.2 采购收货与入库规则

**完成采购操作**：
- 权限：`warehouse` 或 `ceo` 角色
- 可操作状态：`approved` 或 `purchasing`
- 操作内容：
  1. 对每个采购明细项：
     - 创建批次（`Batch`）
     - 增加库存（从批次汇总）
     - 记录库存变动（类型为`purchase_in`）
     - 更新已收货数量
  2. 任务状态 → `completed`

**批次创建规则**：
- 批次号可以手动输入或自动生成
- 批次日期默认为今天
- 批次单价从采购明细中获取
- 过期日期可选
- 供应商信息存储在批次备注中

**潜在歧义**：
- ⚠️ 采购任务明细中的`received_quantity`字段，如果分多次收货，如何处理？当前规则是直接完成，不支持部分收货
- ⚠️ 如果采购数量与收货数量不一致，如何处理？规则未明确
- ⚠️ `PurchaseTask.supplier`使用字符串字段，而`Supplier`模型存在但未使用，数据不一致

---

### 1.4 物流发货流程

#### 1.4.1 发货单状态流转规则

**状态定义**：
- `pending`：待发货
- `loading`：装车中
- `shipped`：已发货
- `delivered`：已送达

**状态流转规则**：
1. **创建发货单**：从发货通知单创建，状态为 `pending`
2. **分配司机和车辆**：状态仍为 `pending`
3. **确认发货**：`pending` → `loading` → `shipped`（权限：`logistics` 或 `ceo`）
4. **确认送达**：`shipped` → `delivered`（权限：`logistics` 或 `ceo`）

**潜在歧义**：
- ⚠️ `loading`状态在代码中定义，但在确认发货时直接从`pending`变为`shipped`，`loading`状态实际不会停留
- ⚠️ 发货单与发货通知单的关系：一个发货通知单可以创建多个发货单吗？规则未明确

#### 1.4.2 发货确认规则

**发货确认操作**：
- 权限：`logistics` 或 `ceo` 角色
- 可操作状态：`loading`（理论上，但实际是`pending`）
- 操作内容：
  1. 对每个订单项，按批次FIFO扣减库存
  2. 记录库存变动（类型为`sale_out`）
  3. 更新库存总数量（从批次汇总）
  4. 发货单状态 → `shipped`
  5. 发货通知单状态 → `shipped`
  6. 订单状态 → `shipped`

**批次分配规则**：
- 优先使用订单中已保存的批次分配（`SalesOrderItemBatch`）
- 允许在发货时调整批次分配数量
- 按批次FIFO原则扣减

**潜在歧义**：
- ⚠️ 发货时如果订单中已保存的批次分配数量不足，如何处理？当前规则是允许调整，但未明确调整的规则
- ⚠️ 发货时如果批次库存不足，如何处理？规则未明确

#### 1.4.3 收货回执规则

**收货回执操作**：
- 权限：`logistics` 或 `ceo` 角色
- 可操作状态：`shipped`
- 操作内容：
  1. 录入收货人信息（姓名、电话）
  2. 录入收货备注
  3. 上传发货回执图片（可选，可多张）
  4. 发货单状态 → `delivered`
  5. 检查订单的所有发货单是否都已送达
  6. 如果所有发货单都已送达，订单状态 → `completed`

**潜在歧义**：
- ⚠️ 如果部分发货单送达，部分未送达，订单状态如何处理？当前规则是只有所有发货单都送达后，订单才变为`completed`
- ⚠️ 收货回执是否必须上传图片？当前规则是"可选"，但业务上可能需要强制要求

---

### 1.5 库存管理规则

#### 1.5.1 库存类型

**库存类型定义**：
- `product`：成品库存
- `material`：原料库存
- `other`：其它类型库存

**库存数量计算**：
- 库存总数量从批次汇总计算（`update_quantity_from_batches()`）
- 批次数量变化时，需要更新库存总数量

**潜在歧义**：
- ⚠️ 任务接收时直接扣减库存总数量（不按批次），但库存总数量应该从批次汇总，这两种方式可能不一致

#### 1.5.2 批次管理规则

**批次创建场景**：
1. 成品入库时创建批次
2. 采购收货时创建批次

**批次扣减规则**：
- 领料单审批时：按批次FIFO扣减
- 发货确认时：按批次FIFO扣减
- 任务接收时：不按批次，直接扣减总数量（不一致）

**批次信息**：
- 批次号：可手动输入或自动生成
- 批次日期：默认为今天
- 批次单价：从产品/原料基础单价获取，可手动调整
- 过期日期：可选
- 供应商信息：存储在备注中

**潜在歧义**：
- ⚠️ 批次扣减规则不一致：任务接收时直接扣减总数量，其他场景按批次FIFO扣减
- ⚠️ 如果批次过期，如何处理？规则未明确
- ⚠️ 批次数量为0时，是否应该删除批次？规则未明确

#### 1.5.3 库存调整规则

**库存调整申请**：
- 权限：申请人可以是任何角色，审批人需要特定权限
- 状态：`pending` → `approved` / `rejected` → `completed`
- 可以调整数量和单价

**潜在歧义**：
- ⚠️ 库存调整申请的审批权限规则未明确
- ⚠️ 库存调整完成后，是否需要创建批次？规则未明确

---

### 1.6 客户管理规则

#### 1.6.1 客户编辑/删除审批规则

**编辑审批流程**：
- 申请编辑：任何角色可以申请
- 审批编辑：需要特定权限（规则未明确）
- 状态：`none` → `pending` → `approved` / `rejected`

**删除审批流程**：
- 申请删除：任何角色可以申请
- 审批删除：需要特定权限（规则未明确）
- 状态：`none` → `pending` → `approved` / `rejected`

**潜在歧义**：
- ⚠️ 客户编辑/删除的审批权限规则未明确
- ⚠️ 如果客户有关联的订单，是否可以删除？规则未明确
- ⚠️ 客户编辑审批通过后，如何应用待审批的数据？规则未明确（数据存储在`edit_pending_data`字段，JSON格式）

#### 1.6.2 客户转移规则

**客户转移**：
- 可以转移客户负责人
- 记录转移历史（`CustomerTransfer`）

**潜在歧义**：
- ⚠️ 客户转移是否需要审批？规则未明确
- ⚠️ 客户转移后，历史订单的负责人如何处理？规则未明确

---

## 二、TODO与潜在歧义总结

### 2.1 状态定义与实际使用不一致

1. **销售订单状态**：
   - `approved`：定义但不会停留
   - `ceo_approved`：定义但不会停留

2. **生产任务状态**：
   - `received`：定义但不会停留
   - `material_preparing`：定义但实际不会停留（任务接收时直接进入`in_production`）

3. **领料单状态**：
   - `issued`：定义但实际不使用

4. **采购任务状态**：
   - `purchasing`：定义但不会停留

5. **发货单状态**：
   - `loading`：定义但不会停留（直接从`pending`到`shipped`）

**建议**：
- 明确这些状态是否还需要，如果不需要，应该从状态选择中移除
- 如果需要，应该明确在什么场景下使用

### 2.2 业务流程规则不完整

1. **订单退回后重新提交规则**：
   - 退回后是否保留原订单号？
   - 退回后是否保留审批历史？
   - 退回后重新提交是否需要重新走完整审批流程？

2. **批次分配与库存锁定规则**：
   - 批次分配后是否应该锁定库存？
   - 如果多个订单分配了相同批次，如何处理？

3. **质检不合格处理规则**：
   - 质检不合格时，任务状态如何处理？
   - 返工（`rework`）的具体流程是什么？

4. **入库数量超需求处理规则**：
   - 入库数量是否可以超过需求数量？
   - 如果超过，如何处理？

5. **采购部分收货规则**：
   - 是否支持分多次收货？
   - 如果支持，如何处理？

6. **订单终结时库存回滚规则**：
   - 已发货订单重新入库时，是否创建新批次？
   - 如果生产任务已完成并已入库，终结时是否需要扣减已入库的成品库存？
   - 如果领料单已发料（原料已扣减），终结时是否需要重新入库原料？

### 2.3 数据一致性问题

1. **供应商数据不一致**：
   - `PurchaseTask.supplier`使用字符串字段
   - `Supplier`模型存在但未使用
   - 建议：统一使用`Supplier`模型，或明确不使用模型的原因

2. **库存扣减方式不一致**：
   - 任务接收时：直接扣减总数量（不按批次）
   - 领料单审批时：按批次FIFO扣减
   - 发货确认时：按批次FIFO扣减
   - 建议：统一库存扣减方式

3. **客户模型位置**：
   - `Customer`模型在`inventory`模块
   - 但主要用于销售业务
   - 建议：明确职责边界，或考虑迁移到`sales`模块

4. **发货通知单职责归属**：
   - `ShippingNotice`模型在`sales`模块
   - 但`logistics`模块大量使用
   - 建议：明确职责边界

### 2.4 权限规则不明确

1. **库存调整申请审批权限**：未明确
2. **客户编辑/删除审批权限**：未明确
3. **客户转移权限**：未明确

### 2.5 业务边界模糊

1. **采购功能重复**：
   - `inventory.PurchaseOrder`（历史遗留）
   - `purchase.PurchaseTask`（当前使用）
   - 建议：明确只使用`PurchaseTask`，冻结`PurchaseOrder`

2. **跨模块函数调用**：
   - `production.views`调用`sales.views.terminate_order_chain`
   - 建议：考虑抽象为服务层函数

---

## 三、补充规则建议

### 3.1 状态流转规则补充

#### 3.1.1 销售订单状态补充规则

**建议规则**：
1. **退回后重新提交规则**：
   - 保留原订单号
   - 保留审批历史（`approved_by`、`approved_at`等字段保留）
   - 重新提交后，状态从`rejected`变为`pending`，需要重新走完整审批流程
   - 清除之前的审批信息（`approved_by`、`approved_at`等字段清空）

2. **批次分配锁定规则**：
   - 批次分配后，应该锁定批次数量（在批次表中增加`locked_quantity`字段）
   - 发货时从锁定数量中扣减
   - 如果订单取消或终结，释放锁定数量

3. **订单终结时库存回滚规则**：
   - 如果订单已发货，重新入库时创建新批次（批次号格式：`RETURN-{原订单号}-{日期}`）
   - 如果生产任务已完成并已入库，终结时需要扣减已入库的成品库存
   - 如果领料单已发料（原料已扣减），终结时需要重新入库原料（创建新批次）

#### 3.1.2 生产任务状态补充规则

**建议规则**：
1. **质检不合格处理规则**：
   - 如果质检结果为`unqualified`（不合格），任务状态保持`qc_checking`，需要重新生产
   - 如果质检结果为`rework`（返工），任务状态变为`in_production`，需要重新生产
   - 重新生产时，是否需要重新领料？建议：不需要，因为原料已经领用

2. **入库数量超需求处理规则**：
   - 允许入库数量超过需求数量（可能因为生产损耗等原因）
   - 如果入库数量 > 需求数量，任务状态仍为`completed`，但记录超产数量
   - 超产数量计入库存，可以用于其他订单

3. **任务接收时库存扣减规则**：
   - 统一改为按批次FIFO扣减，与领料单审批时保持一致
   - 或者，任务接收时不扣减库存，只有领料单审批时才扣减

#### 3.1.3 采购任务状态补充规则

**建议规则**：
1. **部分收货规则**：
   - 支持分多次收货
   - 每次收货时，更新`received_quantity`字段
   - 只有当所有明细项的`received_quantity` >= `quantity`时，任务状态才变为`completed`

2. **采购数量与收货数量不一致处理规则**：
   - 如果收货数量 < 采购数量，允许部分收货，任务状态保持`approved`或`purchasing`
   - 如果收货数量 > 采购数量，允许超收，但需要记录超收原因

3. **供应商数据统一规则**：
   - 将`PurchaseTask.supplier`改为`ForeignKey(Supplier)`
   - 统一使用`Supplier`模型管理供应商信息

#### 3.1.4 发货单状态补充规则

**建议规则**：
1. **发货单与发货通知单关系规则**：
   - 一个发货通知单可以创建多个发货单（支持分批发货）
   - 只有当所有发货单都送达后，发货通知单状态才变为`delivered`

2. **发货时批次分配调整规则**：
   - 如果订单中已保存的批次分配数量不足，允许从其他批次补充
   - 如果批次库存不足，不允许发货，需要提示用户

3. **收货回执强制规则**：
   - 建议：收货回执必须上传至少一张图片
   - 或者，收货回执必须填写收货人信息

### 3.2 权限规则补充

#### 3.2.1 库存调整申请审批权限

**建议规则**：
- 审批权限：`warehouse` 或 `ceo` 角色
- 申请人可以是任何角色

#### 3.2.2 客户编辑/删除审批权限

**建议规则**：
- 编辑审批权限：`sales_mgr` 或 `ceo` 角色
- 删除审批权限：`ceo` 角色（删除操作更敏感）
- 客户转移权限：`sales_mgr` 或 `ceo` 角色

#### 3.2.3 客户编辑数据应用规则

**建议规则**：
- 编辑审批通过后，从`edit_pending_data`字段（JSON格式）解析数据
- 更新客户的实际字段
- 清除`edit_pending_data`字段
- 如果客户有关联的订单，编辑审批需要更高级别权限（如`ceo`）

### 3.3 数据一致性规则补充

#### 3.3.1 库存扣减方式统一规则

**建议规则**：
- **统一使用批次FIFO扣减**：
  - 任务接收时：不扣减库存，只有领料单审批时才扣减
  - 领料单审批时：按批次FIFO扣减
  - 发货确认时：按批次FIFO扣减
- **或者，统一使用总数量扣减**（不推荐，因为无法追踪批次）

#### 3.3.2 批次管理规则补充

**建议规则**：
1. **批次过期处理规则**：
   - 批次过期后，在库存列表中标记为"已过期"
   - 发货时优先使用未过期的批次
   - 如果只有过期批次，需要特殊审批才能发货

2. **批次数量为0处理规则**：
   - 批次数量为0时，不删除批次，保留历史记录
   - 在批次列表中标记为"已用完"

3. **批次锁定规则**：
   - 在批次表中增加`locked_quantity`字段
   - 订单批次分配时，锁定批次数量
   - 发货时从锁定数量中扣减
   - 订单取消或终结时，释放锁定数量

### 3.4 业务边界规则补充

#### 3.4.1 采购功能边界规则

**建议规则**：
- **明确只使用`PurchaseTask`**：
  - 冻结`inventory.PurchaseOrder`相关功能（模型、admin、views、templates）
  - 不在新开发中使用`PurchaseOrder`
  - 如果未来需要，考虑迁移`PurchaseOrder`的数据到`PurchaseTask`

#### 3.4.2 跨模块调用规则

**建议规则**：
- **创建服务层**：
  - 将`terminate_order_chain`等跨模块函数移到服务层（如`factory_system/services/`）
  - 各模块通过服务层调用，而不是直接调用其他模块的views
  - 降低模块间耦合度

#### 3.4.3 客户模型职责边界规则

**建议规则**：
- **保持现状**：
  - `Customer`模型继续在`inventory`模块
  - 明确`Customer`是"基础数据"，属于库存管理的基础信息
  - 如果未来重构，考虑创建独立的`common`模块存放共享基础数据

#### 3.4.4 发货通知单职责边界规则

**建议规则**：
- **保持现状**：
  - `ShippingNotice`模型继续在`sales`模块
  - 明确`ShippingNotice`是"销售流程的输出"，是销售订单审批后生成的"发货指令"
  - `logistics`模块消费`ShippingNotice`，创建发货单

---

## 四、总结

### 4.1 业务规则完整性评价

**已明确的规则**：
- ✅ 销售订单审批流程
- ✅ 生产任务基本流程
- ✅ 采购任务基本流程
- ✅ 物流发货基本流程
- ✅ 库存批次管理基本规则

**待补充的规则**：
- ⚠️ 状态流转的边界情况处理
- ⚠️ 异常情况的处理（如质检不合格、库存不足等）
- ⚠️ 数据一致性规则
- ⚠️ 权限规则细节

### 4.2 潜在风险点

1. **库存扣减方式不一致**：可能导致库存数据不准确
2. **批次分配未锁定**：可能导致多个订单分配相同批次，库存不足
3. **状态定义与实际使用不一致**：可能导致理解困惑和业务逻辑错误
4. **数据模型不一致**：如`Supplier`模型存在但未使用

### 4.3 建议优先级

**高优先级**：
1. 统一库存扣减方式
2. 补充批次分配锁定规则
3. 明确状态定义与实际使用的一致性

**中优先级**：
1. 补充异常情况处理规则
2. 明确权限规则细节
3. 统一供应商数据模型

**低优先级**：
1. 优化模块职责边界
2. 创建服务层抽象

---

**文档生成时间**：2026-01-14  
**分析人员**：业务 Agent  
**文档状态**：业务规则分析报告，供开发参考
