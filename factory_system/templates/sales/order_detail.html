{% extends 'base.html' %}

{% block title %}订单详情 - {{ order.order_no }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between">
        <h4>订单详情 - {{ order.order_no }}</h4>
        <div>
            {% if order.status == 'pending' %}
                {% if user.profile.role == 'sales_mgr' or user.profile.role == 'ceo' %}
                <a href="{% url 'sales:order_approve' order.pk %}" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> 审批
                </a>
                <a href="{% url 'sales:order_reject' order.pk %}" class="btn btn-warning">
                    <i class="bi bi-arrow-return-left"></i> 退回订单
                </a>
                {% endif %}
            {% endif %}
            {% if order.status == 'ceo_pending' and user.profile.role == 'ceo' %}
            <a href="{% url 'sales:ceo_approve' order.pk %}" class="btn btn-success">
                <i class="bi bi-check-circle"></i> 总经理审批
            </a>
            <a href="{% url 'sales:ceo_reject' order.pk %}" class="btn btn-warning">
                <i class="bi bi-arrow-return-left"></i> 退回订单
            </a>
            {% endif %}
            {% if order.status == 'pending' and order.salesperson == user %}
            <a href="{% url 'sales:order_cancel' order.pk %}" class="btn btn-danger">
                <i class="bi bi-x-circle"></i> 取消订单
            </a>
            {% endif %}
            {% if order.status == 'rejected' and order.salesperson == user %}
            <a href="{% url 'sales:order_edit' order.pk %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> 编辑并重新提交
            </a>
            {% endif %}
            {% if order.status == 'in_production' or order.status == 'ready_to_ship' or order.status == 'shipped' %}
                {% if user.profile.role == 'ceo' %}
                <a href="{% url 'sales:order_terminate' order.pk %}" class="btn btn-danger">
                    <i class="bi bi-x-octagon"></i> 终结流程
                </a>
                {% endif %}
            {% endif %}
            <a href="{% url 'sales:order_list' %}" class="btn btn-secondary">返回列表</a>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>基本信息</h5>
                <table class="table table-bordered">
                    <tr>
                        <th width="30%">订单号</th>
                        <td>{{ order.order_no }}</td>
                    </tr>
                    <tr>
                        <th>客户</th>
                        <td>{{ order.customer.name }}</td>
                    </tr>
                    <tr>
                        <th>销售员</th>
                        <td>{{ order.salesperson.username }}</td>
                    </tr>
                    <tr>
                        <th>状态</th>
                        <td>
                            {% if order.status == 'pending' %}
                            <span class="badge bg-warning">待审批</span>
                            {% elif order.status == 'approved' %}
                            <span class="badge bg-info">已审批</span>
                            {% elif order.status == 'ceo_pending' %}
                            <span class="badge bg-warning">待总经理审批</span>
                            {% elif order.status == 'ceo_approved' %}
                            <span class="badge bg-info">总经理已审批</span>
                            {% elif order.status == 'rejected' %}
                            <span class="badge bg-danger">已退回</span>
                            {% elif order.status == 'in_production' %}
                            <span class="badge bg-primary">生产中</span>
                            {% elif order.status == 'ready_to_ship' %}
                            <span class="badge" style="background-color: #fd7e14;">待发货</span>
                            {% elif order.status == 'shipped' %}
                            <span class="badge bg-secondary">已发货</span>
                            {% elif order.status == 'completed' %}
                            <span class="badge bg-success">已完成</span>
                            {% elif order.status == 'cancelled' %}
                            <span class="badge bg-dark">已取消</span>
                            {% elif order.status == 'terminated' %}
                            <span class="badge bg-danger">已终结</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if order.approved_by %}
                    <tr>
                        <th>审批人</th>
                        <td>{{ order.approved_by.username }} - {{ order.approved_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% endif %}
                    {% if order.ceo_approved_by %}
                    <tr>
                        <th>总经理审批人</th>
                        <td>{{ order.ceo_approved_by.username }} - {{ order.ceo_approved_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% endif %}
                    {% if order.status == 'rejected' %}
                    <tr>
                        <th>退回原因</th>
                        <td>
                            <div class="alert alert-warning mb-0">
                                {{ order.reject_reason|default:"无" }}
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>退回人</th>
                        <td>{{ order.rejected_by.username|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>退回时间</th>
                        <td>{{ order.rejected_at|date:"Y-m-d H:i"|default:"-" }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>订单总额</th>
                        <td><strong>¥{{ order.total_amount }}</strong></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-12">
                <h5>订单明细及批次分配</h5>
                <div class="table-responsive">
                <table class="table table-bordered">
                        <thead class="table-light">
                        <tr>
                            <th>产品</th>
                                <th>需求数量</th>
                            <th>单价</th>
                                <th>已分配批次</th>
                                <th>批次分配详情</th>
                                <th>缺口数量</th>
                            <th>小计</th>
                        </tr>
                    </thead>
                    <tbody>
                            {% for item_info in items_with_batch_info %}
                            <tr>
                                <td>
                                    <strong>{{ item_info.item.product.name }}</strong><br>
                                    <small class="text-muted">{{ item_info.item.product.sku }}</small>
                                </td>
                                <td>
                                    <strong>{{ item_info.item.quantity }}{{ item_info.item.product.unit }}</strong>
                                </td>
                                <td>¥{{ item_info.item.unit_price }}</td>
                                <td>
                                    {% if item_info.batch_allocated_qty > 0 %}
                                    <span class="badge bg-info">{{ item_info.batch_allocated_qty }}{{ item_info.item.product.unit }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">未分配</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item_info.batch_allocations %}
                                    <ul class="mb-0" style="list-style: none; padding-left: 0;">
                                        {% for batch in item_info.batch_allocations %}
                                        <li>
                                            <small>
                                                {{ batch.batch_no }} ({{ batch.batch_date|date:"Y-m-d" }})：
                                                <strong>{{ batch.quantity }}{{ batch.unit }}</strong>
                                            </small>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item_info.shortage > 0 %}
                                    <span class="badge bg-warning">{{ item_info.shortage }}{{ item_info.item.product.unit }}</span>
                                    <br><small class="text-muted">需生产</small>
                                    {% else %}
                                    <span class="badge bg-success">充足</span>
                                    {% endif %}
                                </td>
                                <td>¥{{ item_info.item.subtotal }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

